<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è™šæ‹Ÿäººç”Ÿ - æ¨¡æ‹Ÿç¤¾äº¤æ¸¸æˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        // Tailwindé…ç½®
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5', // ä¸»è‰²è°ƒï¼šæ·±ç´«è‰²ï¼Œä»£è¡¨è™šæ‹Ÿä¸ç¥ç§˜
                        secondary: '#10B981', // è¾…åŠ©è‰²ï¼šç»¿è‰²ï¼Œä»£è¡¨ç”Ÿå‘½ä¸æ´»åŠ›
                        accent: '#F59E0B', // å¼ºè°ƒè‰²ï¼šæ©™è‰²ï¼Œä»£è¡¨æ´»åŠ›ä¸ç¤¾äº¤
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .text-shadow-lg {
                text-shadow: 0 4px 8px rgba(0,0,0,0.12), 0 2px 4px rgba(0,0,0,0.08);
            }
            .animate-path {
                stroke-dasharray: 10;
                animation: dash 20s linear infinite;
            }
            @keyframes dash {
                to {
                    stroke-dashoffset: 1000;
                }
            }
            .avatar-pulse {
                position: relative;
            }
            .avatar-pulse::after {
                content: '';
                position: absolute;
                top: -2px;
                left: -2px;
                right: -2px;
                bottom: -2px;
                border-radius: 50%;
                border: 2px solid rgba(16, 185, 129, 0.5);
                animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
            }
            @keyframes pulse-ring {
                0% { transform: scale(0.95); opacity: 1; }
                70% { transform: scale(1.2); opacity: 0; }
                100% { transform: scale(0.95); opacity: 0; }
            }
            .chat-bubble-left::before {
                content: '';
                position: absolute;
                left: -8px;
                top: 10px;
                width: 0;
                height: 0;
                border-top: 8px solid transparent;
                border-right: 8px solid theme('colors.light');
                border-bottom: 8px solid transparent;
            }
            .chat-bubble-right::before {
                content: '';
                position: absolute;
                right: -8px;
                top: 10px;
                width: 0;
                height: 0;
                border-top: 8px solid transparent;
                border-left: 8px solid theme('colors.primary/10');
                border-bottom: 8px solid transparent;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen font-sans text-dark overflow-x-hidden">
    <!-- é¡µé¢åŠ è½½åŠ¨ç”» -->
    <div id="loader" class="fixed inset-0 z-50 flex items-center justify-center bg-white">
        <div class="flex flex-col items-center">
            <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-primary font-medium">è½½å…¥è™šæ‹Ÿä¸–ç•Œä¸­...</p>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div id="app" class="hidden relative">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <header class="bg-white/80 backdrop-blur-md shadow-sm fixed top-0 left-0 right-0 z-40 transition-all duration-300">
            <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <i class="fa fa-globe text-primary text-2xl"></i>
                    <h1 class="text-xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">è™šæ‹Ÿäººç”Ÿ</h1>
                </div>
                
                <div class="flex items-center space-x-6">
                    <button id="time-control-btn" class="flex items-center space-x-1 text-sm text-slate-600 hover:text-primary transition-colors">
                        <i class="fa fa-clock-o"></i>
                        <span>æ—¶é—´: 60x</span>
                    </button>
                    
                    <button id="log-btn" class="flex items-center space-x-1 text-sm text-slate-600 hover:text-primary transition-colors relative">
                        <i class="fa fa-book"></i>
                        <span>æ—¥å¿—</span>
                        <span id="log-notification" class="absolute -top-1 -right-1 w-4 h-4 bg-accent text-white text-xs rounded-full flex items-center justify-center hidden">1</span>
                    </button>
                    
                    <div id="player-info" class="flex items-center space-x-2">
                        <div class="w-8 h-8 rounded-full overflow-hidden border-2 border-primary">
                            <img id="player-avatar-mini" src="https://picsum.photos/id/64/100/100" alt="ç©å®¶å¤´åƒ" class="w-full h-full object-cover">
                        </div>
                        <span id="player-name-mini" class="font-medium text-sm">æ–°äººå†’é™©è€…</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- äººç‰©åˆ›å»ºç•Œé¢ -->
        <section id="character-creation" class="min-h-screen flex items-center justify-center p-4 pt-20">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl overflow-hidden transform transition-all duration-500">
                <div class="bg-gradient-to-r from-primary to-secondary p-6 text-white">
                    <h2 class="text-2xl font-bold mb-2">åˆ›å»ºä½ çš„è™šæ‹Ÿäººç‰©</h2>
                    <p class="opacity-90">å®šåˆ¶ä½ çš„è§’è‰²ï¼Œå¼€å§‹è™šæ‹Ÿäººç”Ÿä¹‹æ—…</p>
                </div>
                
                <div class="p-6">
                    <form id="creation-form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1" for="nickname">æ˜µç§°</label>
                                <input type="text" id="nickname" name="nickname" placeholder="è¾“å…¥ä½ çš„äºŒæ¬¡å…ƒæ˜µç§° (å¦‚: æ˜Ÿé‡ã¿ã‚†ã)" 
                                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">æ€§åˆ«</label>
                                <div class="flex space-x-4">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="gender" value="male" checked class="w-4 h-4 text-primary focus:ring-primary/50">
                                        <span class="ml-2 text-sm">ç”·</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="gender" value="female" class="w-4 h-4 text-primary focus:ring-primary/50">
                                        <span class="ml-2 text-sm">å¥³</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="gender" value="other" class="w-4 h-4 text-primary focus:ring-primary/50">
                                        <span class="ml-2 text-sm">å…¶ä»–</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-3">å¤´åƒé€‰æ‹©</label>
                            <div class="grid grid-cols-5 gap-3">
                                <div class="avatar-option cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-primary transition-all">
                                    <img src="https://picsum.photos/id/64/100/100" alt="å¤´åƒé€‰é¡¹1" class="w-full aspect-square object-cover">
                                </div>
                                <div class="avatar-option cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-primary transition-all">
                                    <img src="https://picsum.photos/id/65/100/100" alt="å¤´åƒé€‰é¡¹2" class="w-full aspect-square object-cover">
                                </div>
                                <div class="avatar-option cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-primary transition-all">
                                    <img src="https://picsum.photos/id/66/100/100" alt="å¤´åƒé€‰é¡¹3" class="w-full aspect-square object-cover">
                                </div>
                                <div class="avatar-option cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-primary transition-all">
                                    <img src="https://picsum.photos/id/67/100/100" alt="å¤´åƒé€‰é¡¹4" class="w-full aspect-square object-cover">
                                </div>
                                <div class="avatar-option cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-primary transition-all">
                                    <img src="https://picsum.photos/id/68/100/100" alt="å¤´åƒé€‰é¡¹5" class="w-full aspect-square object-cover">
                                </div>
                            </div>
                            <input type="hidden" id="avatar-url" value="https://picsum.photos/id/64/100/100">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">æ€§æ ¼ç±»å‹ (MBTI)</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <select id="personality" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                                    <option value="INFP">è°ƒåœè€… - ç†æƒ³ä¸»ä¹‰ï¼Œå¯Œæœ‰æ´å¯ŸåŠ›</option>
                                    <option value="ENFP">è¿½æ¢¦äºº - çƒ­æƒ…ï¼Œæœ‰åˆ›é€ åŠ›ï¼Œç¤¾äº¤èƒ½åŠ›å¼º</option>
                                    <option value="INFJ">å’¨è¯¢å¸ˆ - å¯Œæœ‰æ´å¯ŸåŠ›ï¼Œæœ‰åŒæƒ…å¿ƒ</option>
                                    <option value="ENFJ">æ•™è‚²å®¶ - æœ‰é­…åŠ›ï¼Œæœ‰è¯´æœåŠ›ï¼Œè´Ÿè´£ä»»</option>
                                    <option value="INTJ">æˆ˜ç•¥å®¶ - æœ‰è¿œè§ï¼Œåˆ†æåŠ›å¼ºï¼Œæœæ–­</option>
                                    <option value="ENTJ">æŒ‡æŒ¥å®˜ - æœæ–­ï¼Œæœ‰é¢†å¯¼åŠ›ï¼Œæœ‰å†³å¿ƒ</option>
                                    <option value="INTP">é€»è¾‘å­¦å®¶ - åˆ†æåŠ›å¼ºï¼Œå¥½å¥‡å¿ƒé‡ï¼Œæœ‰åˆ›é€ åŠ›</option>
                                    <option value="ENTP">è¾©è®ºå®¶ - èªæ˜ï¼Œæœºæ™ºï¼Œå–œæ¬¢æŒ‘æˆ˜</option>
                                    <option value="ISFP">è‰ºæœ¯å®¶ - çµæ´»ï¼Œæ•æ„Ÿï¼Œå–„äºè§‚å¯Ÿ</option>
                                    <option value="ESFP">è¡¨æ¼”è€… - å¤–å‘ï¼Œå‹å¥½ï¼Œå–œæ¬¢äº«å—ç”Ÿæ´»</option>
                                    <option value="ISFJ">å®ˆå«è€… - æœ‰è´£ä»»å¿ƒï¼Œå¿ è¯šï¼Œå‘¨åˆ°</option>
                                    <option value="ESFJ">é¢†äº‹ - çƒ­å¿ƒï¼Œæœ‰ç»„ç»‡èƒ½åŠ›ï¼Œå–„äºç¤¾äº¤</option>
                                    <option value="ISTP">æ‰‹è‰ºäºº - çµæ´»ï¼Œå®é™…ï¼Œå–„äºè§£å†³é—®é¢˜</option>
                                    <option value="ESTP">åˆ›ä¸šè€… - å®é™…ï¼Œæœæ–­ï¼Œå–œæ¬¢è¡ŒåŠ¨</option>
                                    <option value="ISTJ">æ£€æŸ¥å®˜ - æœ‰è´£ä»»å¿ƒï¼Œç»†è‡´ï¼Œå¯é </option>
                                    <option value="ESTJ">æ€»ç»ç† - æœæ–­ï¼Œæœ‰ç»„ç»‡èƒ½åŠ›ï¼Œè´Ÿè´£ä»»</option>
                                </select>
                                
                                <button type="button" id="random-personality" class="flex items-center justify-center space-x-2 px-4 py-2 border border-primary text-primary rounded-lg hover:bg-primary hover:text-white transition-all">
                                    <i class="fa fa-random"></i>
                                    <span>éšæœºæ€§æ ¼</span>
                                </button>
                            </div>
                            <p id="personality-description" class="mt-2 text-sm text-slate-600 italic">è¿™ç§æ€§æ ¼çš„äººå¯Œæœ‰ç†æƒ³ä¸»ä¹‰ï¼Œå¯¹ä»–äººå¯Œæœ‰åŒæƒ…å¿ƒï¼Œå–œæ¬¢æ¢ç´¢äººç”Ÿçš„æ„ä¹‰å’Œä»·å€¼ã€‚</p>
                        </div>
                        
                        <div class="pt-4">
                            <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-3 px-4 rounded-lg transition-all shadow-md hover:shadow-lg flex items-center justify-center space-x-2">
                                <span>å¼€å§‹è™šæ‹Ÿäººç”Ÿ</span>
                                <i class="fa fa-arrow-right"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- æ¸¸æˆä¸»ç•Œé¢ -->
        <section id="game-world" class="hidden pt-16 p-4">
            <div class="container mx-auto">
                <div class="flex flex-col lg:flex-row gap-4">
                    <!-- åœ°å›¾åŒºåŸŸ -->
                    <div class="lg:w-3/4 bg-white rounded-xl shadow-md overflow-hidden relative">
                        <div class="p-3 bg-slate-50 border-b flex justify-between items-center">
                            <h2 class="font-semibold text-slate-700">è™šæ‹ŸXä¸–ç•Œ</h2>
                            <div class="flex items-center space-x-2">
                                <button id="move-mode-toggle" class="text-xs px-2 py-1 bg-primary/10 text-primary rounded hover:bg-primary/20 transition-colors">
                                    <i class="fa fa-random mr-1"></i>éšæœºç§»åŠ¨
                                </button>
                                <span class="text-xs text-slate-500">ç‚¹å‡»åœ°å›¾æŒ‡å®šç§»åŠ¨ä½ç½®</span>
                            </div>
                        </div>
                        
                        <!-- åœ°å›¾å®¹å™¨ -->
                        <div id="map-container" class="relative w-full aspect-square max-w-[800px] mx-auto">
                            <!-- åœ°å›¾èƒŒæ™¯ -->
                            <div id="map" class="absolute inset-0 bg-slate-100">
                                <!-- åœ°å›¾å°†é€šè¿‡JSç»˜åˆ¶ -->
                            </div>
                            
                            <!-- äººç‰©å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                        </div>
                        
                        <!-- èŠå¤©çª—å£ (é»˜è®¤éšè—) -->
                        <div id="chat-window" class="hidden absolute bottom-4 left-1/2 transform -translate-x-1/2 w-[90%] max-w-md bg-white rounded-xl shadow-lg p-4 border border-slate-200 z-30">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-medium text-slate-800" id="chat-title">ä¸ [äººç‰©åç§°] èŠå¤©ä¸­</h3>
                                <span id="compatibility" class="text-xs px-2 py-0.5 bg-green-100 text-green-800 rounded-full">æ€§æ ¼åŒ¹é…åº¦: 75%</span>
                            </div>
                            
                            <div id="chat-messages" class="h-40 overflow-y-auto mb-3 space-y-3 p-2">
                                <!-- èŠå¤©æ¶ˆæ¯å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                            </div>
                            
                            <div class="flex space-x-2">
                                <!-- ç§»é™¤å‘é€æ¶ˆæ¯æŒ‰é’®ï¼Œæ”¹ä¸ºå®Œå…¨è‡ªåŠ¨èŠå¤© -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- å³ä¾§é¢æ¿ -->
                    <div class="lg:w-1/4 space-y-4">
                        <!-- äººç‰©ä¿¡æ¯ -->
                        <div class="bg-white rounded-xl shadow-md overflow-hidden">
                            <div class="bg-gradient-to-r from-primary/20 to-secondary/20 p-4">
                                <h2 class="font-semibold text-slate-800">äººç‰©ä¿¡æ¯</h2>
                            </div>
                            <div class="p-4">
                                <div class="flex items-center space-x-3 mb-4">
                                    <div class="w-16 h-16 rounded-full overflow-hidden border-2 border-primary">
                                        <img id="player-avatar" src="https://picsum.photos/id/64/100/100" alt="ç©å®¶å¤´åƒ" class="w-full h-full object-cover">
                                    </div>
                                    <div>
                                        <h3 id="player-name" class="font-medium text-lg">æ–°äººå†’é™©è€…</h3>
                                        <p id="player-personality" class="text-sm text-slate-600">è°ƒåœè€… (INFP)</p>
                                    </div>
                                </div>
                                
                                <div class="space-y-2">
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="text-slate-600">å½“å‰ä½ç½®:</span>
                                        <span id="player-location" class="font-medium">å®¶é™„è¿‘</span>
                                    </div>
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="text-slate-600">å·²è®¤è¯†:</span>
                                        <span id="acquaintance-count" class="font-medium">0 äºº</span>
                                    </div>
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="text-slate-600">ä»Šæ—¥æ´»åŠ¨:</span>
                                        <span id="today-activities" class="font-medium">0 ä»¶</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å…¶ä»–äººç‰©åˆ—è¡¨ -->
                        <div class="bg-white rounded-xl shadow-md overflow-hidden">
                            <div class="bg-gradient-to-r from-primary/20 to-secondary/20 p-4">
                                <h2 class="font-semibold text-slate-800">è™šæ‹Ÿå±…æ°‘</h2>
                            </div>
                            <div id="npcs-list" class="max-h-64 overflow-y-auto">
                                <!-- NPCåˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                            </div>
                        </div>
                        
                        <!-- æ—¶é—´æ§åˆ¶ -->
                        <div class="bg-white rounded-xl shadow-md overflow-hidden">
                            <div class="bg-gradient-to-r from-primary/20 to-secondary/20 p-4">
                                <h2 class="font-semibold text-slate-800">æ—¶é—´æ§åˆ¶</h2>
                            </div>
                            <div class="p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-sm text-slate-600">æ—¶é—´æµé€Ÿ</span>
                                    <span id="time-multiplier" class="font-medium">60x</span>
                                </div>
                                <input type="range" id="time-control" min="1" max="300" value="60" 
                                    class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-primary">
                                <div class="flex justify-between text-xs text-slate-500 mt-1">
                                    <span>1x</span>
                                    <span>150x</span>
                                    <span>300x</span>
                                </div>
                                
                                <div class="mt-4 pt-4 border-t border-slate-100">
                                    <div class="text-center text-sm text-slate-500 mb-1">è™šæ‹Ÿä¸–ç•Œæ—¶é—´</div>
                                    <div id="virtual-time" class="text-center font-medium">09:00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- æ—¥å¿—é¢æ¿ (é»˜è®¤éšè—) -->
        <div id="log-panel" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="font-bold text-lg">äººç”Ÿæ—¥å¿—</h2>
                    <button id="close-log" class="text-slate-500 hover:text-slate-700 transition-colors">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                
                <div id="log-content" class="flex-1 overflow-y-auto p-4 space-y-4">
                    <!-- æ—¥å¿—å†…å®¹å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                    <div class="text-center text-slate-500 py-8">
                        <i class="fa fa-book-open text-4xl mb-2 opacity-30"></i>
                        <p>ä½ çš„äººç”Ÿæ—¥å¿—è¿˜æ˜¯ç©ºç™½çš„</p>
                        <p class="text-sm mt-1">ä¸å…¶ä»–äººç‰©äº’åŠ¨æ¥è®°å½•ç²¾å½©ç¬é—´</p>
                    </div>
                </div>
                
                <div class="p-4 border-t">
                    <button id="clear-log" class="text-sm text-slate-600 hover:text-red-500 transition-colors">
                        <i class="fa fa-trash mr-1"></i> æ¸…ç©ºæ—¥å¿—
                    </button>
                </div>
            </div>
        </div>

        <!-- ç§ä¿¡çª—å£ (é»˜è®¤éšè—) -->
        <div id="message-window" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="font-bold text-lg">å‘é€ç§ä¿¡ç»™ <span id="message-recipient">äººç‰©åç§°</span></h2>
                    <button id="close-message" class="text-slate-500 hover:text-slate-700 transition-colors">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                
                <div class="p-4">
                    <textarea id="message-content" rows="5" placeholder="è¾“å…¥ä½ æƒ³å‘é€çš„æ¶ˆæ¯..." 
                        class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all resize-none"></textarea>
                </div>
                
                <div class="p-4 border-t flex justify-end space-x-3">
                    <button id="cancel-message" class="px-4 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 transition-colors">
                        å–æ¶ˆ
                    </button>
                    <button id="send-message" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        å‘é€
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆä¸»é€»è¾‘
        document.addEventListener('DOMContentLoaded', () => {
            // é¡µé¢åŠ è½½
            setTimeout(() => {
                document.getElementById('loader').classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('app').classList.remove('hidden');
                }, 500);
            }, 1500);
            
            // å…¨å±€çŠ¶æ€
            const gameState = {
                player: null,
                npcs: [],
                mapSize: 800,
                gridSize: 100, // 100px per grid
                moveMode: 'random', // 'random' or 'direct'
                timeMultiplier: 60,
                virtualTime: new Date(2023, 0, 1, 9, 0, 0), // åˆå§‹æ—¶é—´ 9:00
                isChatting: false,
                currentChatPartner: null,
                log: [],
                // æ·»åŠ æœ€è¿‘èŠå¤©è®°å½•ï¼Œç”¨äºé¿å…é‡å¤èŠå¤©
                recentChats: [] // å­˜å‚¨ {npcId, timestamp}
            };
            
            // æ€§æ ¼ç±»å‹å’Œæè¿°
            const personalityTypes = {
                'INFP': 'è°ƒåœè€… - ç†æƒ³ä¸»ä¹‰ï¼Œå¯Œæœ‰æ´å¯ŸåŠ›ï¼Œå¯¹ä»–äººå¯Œæœ‰åŒæƒ…å¿ƒ',
                'ENFP': 'è¿½æ¢¦äºº - çƒ­æƒ…ï¼Œæœ‰åˆ›é€ åŠ›ï¼Œç¤¾äº¤èƒ½åŠ›å¼ºï¼Œå……æ»¡æ´»åŠ›',
                'INFJ': 'å’¨è¯¢å¸ˆ - å¯Œæœ‰æ´å¯ŸåŠ›ï¼Œæœ‰åŒæƒ…å¿ƒï¼Œåšå®šè€Œæœ‰è¯´æœåŠ›',
                'ENFJ': 'æ•™è‚²å®¶ - æœ‰é­…åŠ›ï¼Œæœ‰è¯´æœåŠ›ï¼Œè´Ÿè´£ä»»ï¼Œå–„äºå¼•å¯¼ä»–äºº',
                'INTJ': 'æˆ˜ç•¥å®¶ - æœ‰è¿œè§ï¼Œåˆ†æåŠ›å¼ºï¼Œæœæ–­ï¼Œå–œæ¬¢ç‹¬ç«‹æ€è€ƒ',
                'ENTJ': 'æŒ‡æŒ¥å®˜ - æœæ–­ï¼Œæœ‰é¢†å¯¼åŠ›ï¼Œæœ‰å†³å¿ƒï¼Œå–„äºç»„ç»‡å’Œè§„åˆ’',
                'INTP': 'é€»è¾‘å­¦å®¶ - åˆ†æåŠ›å¼ºï¼Œå¥½å¥‡å¿ƒé‡ï¼Œæœ‰åˆ›é€ åŠ›ï¼Œå–œæ¬¢æŠ½è±¡æ€ç»´',
                'ENTP': 'è¾©è®ºå®¶ - èªæ˜ï¼Œæœºæ™ºï¼Œå–œæ¬¢æŒ‘æˆ˜ï¼Œå–„äºå‘ç°é—®é¢˜',
                'ISFP': 'è‰ºæœ¯å®¶ - çµæ´»ï¼Œæ•æ„Ÿï¼Œå–„äºè§‚å¯Ÿï¼Œå–œæ¬¢é€šè¿‡è¡ŒåŠ¨è¡¨è¾¾è‡ªå·±',
                'ESFP': 'è¡¨æ¼”è€… - å¤–å‘ï¼Œå‹å¥½ï¼Œå–œæ¬¢äº«å—ç”Ÿæ´»ï¼Œå–„äºå³å…´å‘æŒ¥',
                'ISFJ': 'å®ˆå«è€… - æœ‰è´£ä»»å¿ƒï¼Œå¿ è¯šï¼Œå‘¨åˆ°ï¼Œå–„äºç…§é¡¾ä»–äºº',
                'ESFJ': 'é¢†äº‹ - çƒ­å¿ƒï¼Œæœ‰ç»„ç»‡èƒ½åŠ›ï¼Œå–„äºç¤¾äº¤ï¼Œé‡è§†å’Œè°',
                'ISTP': 'æ‰‹è‰ºäºº - çµæ´»ï¼Œå®é™…ï¼Œå–„äºè§£å†³é—®é¢˜ï¼Œå–œæ¬¢åŠ¨æ‰‹æ“ä½œ',
                'ESTP': 'åˆ›ä¸šè€… - å®é™…ï¼Œæœæ–­ï¼Œå–œæ¬¢è¡ŒåŠ¨ï¼Œå–„äºæŠŠæ¡æœºä¼š',
                'ISTJ': 'æ£€æŸ¥å®˜ - æœ‰è´£ä»»å¿ƒï¼Œç»†è‡´ï¼Œå¯é ï¼Œé‡è§†ä¼ ç»Ÿå’Œè§„åˆ™',
                'ESTJ': 'æ€»ç»ç† - æœæ–­ï¼Œæœ‰ç»„ç»‡èƒ½åŠ›ï¼Œè´Ÿè´£ä»»ï¼Œå–œæ¬¢æ˜ç¡®çš„ç»“æ„'
            };
            
            // æ€§æ ¼æè¿°è¯¦æƒ…
            const personalityDescriptions = {
                'INFP': 'è¿™ç§æ€§æ ¼çš„äººå¯Œæœ‰ç†æƒ³ä¸»ä¹‰ï¼Œå¯¹ä»–äººå¯Œæœ‰åŒæƒ…å¿ƒï¼Œå–œæ¬¢æ¢ç´¢äººç”Ÿçš„æ„ä¹‰å’Œä»·å€¼ã€‚ä»–ä»¬é€šå¸¸å®‰é™ã€å†…æ•›ï¼Œä½†å†…å¿ƒä¸–ç•Œä¸°å¯Œï¼Œå¯¹ç¾å’Œæƒ…æ„Ÿæœ‰æ·±åˆ»çš„ç†è§£ã€‚',
                'ENFP': 'è¿™ç§æ€§æ ¼çš„äººå……æ»¡çƒ­æƒ…å’Œåˆ›é€ åŠ›ï¼Œç¤¾äº¤èƒ½åŠ›å¼ºï¼Œå¯¹ç”Ÿæ´»å……æ»¡å¥½å¥‡ã€‚ä»–ä»¬å–„äºæ¿€åŠ±ä»–äººï¼Œå–œæ¬¢æ–°çš„ä½“éªŒå’Œæƒ³æ³•ï¼Œå¾€å¾€èƒ½ç»™å‘¨å›´çš„äººå¸¦æ¥æ´»åŠ›ã€‚',
                'INFJ': 'è¿™ç§æ€§æ ¼çš„äººå¯Œæœ‰æ´å¯ŸåŠ›å’ŒåŒæƒ…å¿ƒï¼Œèƒ½å¤Ÿç†è§£ä»–äººçš„æ„Ÿå—å’ŒåŠ¨æœºã€‚ä»–ä»¬é€šå¸¸æœ‰å¼ºçƒˆçš„ä»·å€¼è§‚ï¼Œåšå®šè€Œæœ‰è¯´æœåŠ›ï¼Œè‡´åŠ›äºå¸®åŠ©ä»–äººæˆé•¿ã€‚',
                'ENFJ': 'è¿™ç§æ€§æ ¼çš„äººæœ‰é­…åŠ›ï¼Œå–„äºç¤¾äº¤ï¼Œæœ‰å¾ˆå¼ºçš„è¯´æœåŠ›å’Œç»„ç»‡èƒ½åŠ›ã€‚ä»–ä»¬é‡è§†äººé™…å…³ç³»ï¼Œå–„äºå¼•å¯¼ä»–äººï¼Œå¾€å¾€åœ¨å›¢é˜Ÿä¸­æ‰®æ¼”é¢†å¯¼è€…çš„è§’è‰²ã€‚',
                'INTJ': 'è¿™ç§æ€§æ ¼çš„äººæœ‰è¿œè§ï¼Œåˆ†æèƒ½åŠ›å¼ºï¼Œå–„äºæˆ˜ç•¥æ€è€ƒã€‚ä»–ä»¬æœæ–­è€Œç‹¬ç«‹ï¼Œå–œæ¬¢æŒ‘æˆ˜å¤æ‚çš„é—®é¢˜ï¼Œå¾€å¾€èƒ½æå‡ºåˆ›æ–°çš„è§£å†³æ–¹æ¡ˆã€‚',
                'ENTJ': 'è¿™ç§æ€§æ ¼çš„äººæœæ–­ï¼Œæœ‰é¢†å¯¼åŠ›ï¼Œå–„äºç»„ç»‡å’Œè§„åˆ’ã€‚ä»–ä»¬æœ‰å¼ºçƒˆçš„å†³å¿ƒå’Œç›®æ ‡æ„Ÿï¼Œèƒ½å¤Ÿæœ‰æ•ˆåœ°æ¨åŠ¨å›¢é˜Ÿå®ç°ç›®æ ‡ã€‚',
                'INTP': 'è¿™ç§æ€§æ ¼çš„äººåˆ†æèƒ½åŠ›å¼ºï¼Œå¥½å¥‡å¿ƒé‡ï¼Œå–œæ¬¢æŠ½è±¡æ€ç»´å’Œé€»è¾‘æ¨ç†ã€‚ä»–ä»¬å–„äºå‘ç°é—®é¢˜ï¼Œæœ‰å¾ˆå¼ºçš„åˆ›é€ åŠ›ï¼Œå¾€å¾€åœ¨ç§‘å­¦å’ŒæŠ€æœ¯é¢†åŸŸè¡¨ç°å‡ºè‰²ã€‚',
                'ENTP': 'è¿™ç§æ€§æ ¼çš„äººèªæ˜ï¼Œæœºæ™ºï¼Œå–œæ¬¢æŒ‘æˆ˜å’Œè¾©è®ºã€‚ä»–ä»¬å–„äºå‘ç°é—®é¢˜å’Œæœºä¼šï¼Œæœ‰å¾ˆå¼ºçš„åº”å˜èƒ½åŠ›ï¼Œå¾€å¾€èƒ½æå‡ºç‹¬ç‰¹çš„è§è§£ã€‚',
                'ISFP': 'è¿™ç§æ€§æ ¼çš„äººçµæ´»ï¼Œæ•æ„Ÿï¼Œå–„äºè§‚å¯Ÿå’Œæ„Ÿå—å‘¨å›´çš„ä¸–ç•Œã€‚ä»–ä»¬å–œæ¬¢é€šè¿‡è¡ŒåŠ¨å’Œè‰ºæœ¯è¡¨è¾¾è‡ªå·±ï¼Œå¾€å¾€æœ‰å¾ˆå¼ºçš„å®¡ç¾èƒ½åŠ›ã€‚',
                'ESFP': 'è¿™ç§æ€§æ ¼çš„äººå¤–å‘ï¼Œå‹å¥½ï¼Œå–œæ¬¢äº«å—ç”Ÿæ´»å’Œç¤¾äº¤ã€‚ä»–ä»¬å–„äºå³å…´å‘æŒ¥ï¼Œèƒ½å¤Ÿç»™å‘¨å›´çš„äººå¸¦æ¥æ¬¢ä¹ï¼Œå¾€å¾€æ˜¯èšä¼šä¸­çš„ç„¦ç‚¹ã€‚',
                'ISFJ': 'è¿™ç§æ€§æ ¼çš„äººæœ‰è´£ä»»å¿ƒï¼Œå¿ è¯šï¼Œå‘¨åˆ°ï¼Œå–„äºç…§é¡¾ä»–äººã€‚ä»–ä»¬é‡è§†ä¼ ç»Ÿå’Œç¨³å®šï¼Œå¾€å¾€æ˜¯å›¢é˜Ÿä¸­å¯é çš„æ”¯æŒè€…ã€‚',
                'ESFJ': 'è¿™ç§æ€§æ ¼çš„äººçƒ­å¿ƒï¼Œæœ‰ç»„ç»‡èƒ½åŠ›ï¼Œå–„äºç¤¾äº¤ï¼Œé‡è§†å’Œè°ã€‚ä»–ä»¬å–„äºç†è§£ä»–äººçš„éœ€æ±‚ï¼Œå¾€å¾€åœ¨ç¤¾åŒºå’Œå›¢é˜Ÿä¸­æ‰®æ¼”ç»„ç»‡è€…çš„è§’è‰²ã€‚',
                'ISTP': 'è¿™ç§æ€§æ ¼çš„äººçµæ´»ï¼Œå®é™…ï¼Œå–„äºè§£å†³é—®é¢˜å’ŒåŠ¨æ‰‹æ“ä½œã€‚ä»–ä»¬å†·é™è€Œç†æ€§ï¼Œå–œæ¬¢é€šè¿‡å®è·µå­¦ä¹ ï¼Œå¾€å¾€åœ¨æŠ€æœ¯å’Œæ‰‹å·¥è‰ºé¢†åŸŸè¡¨ç°å‡ºè‰²ã€‚',
                'ESTP': 'è¿™ç§æ€§æ ¼çš„äººå®é™…ï¼Œæœæ–­ï¼Œå–œæ¬¢è¡ŒåŠ¨å’Œå†’é™©ã€‚ä»–ä»¬å–„äºæŠŠæ¡æœºä¼šï¼Œæœ‰å¾ˆå¼ºçš„åº”å˜èƒ½åŠ›ï¼Œå¾€å¾€åœ¨å±æœºä¸­è¡¨ç°å‡ºè‰²ã€‚',
                'ISTJ': 'è¿™ç§æ€§æ ¼çš„äººæœ‰è´£ä»»å¿ƒï¼Œç»†è‡´ï¼Œå¯é ï¼Œé‡è§†ä¼ ç»Ÿå’Œè§„åˆ™ã€‚ä»–ä»¬å–„äºç»„ç»‡å’Œç®¡ç†ï¼Œå¾€å¾€åœ¨éœ€è¦ç²¾ç¡®å’Œè€å¿ƒçš„å·¥ä½œä¸­è¡¨ç°å‡ºè‰²ã€‚',
                'ESTJ': 'è¿™ç§æ€§æ ¼çš„äººæœæ–­ï¼Œæœ‰ç»„ç»‡èƒ½åŠ›ï¼Œè´Ÿè´£ä»»ï¼Œå–œæ¬¢æ˜ç¡®çš„ç»“æ„å’Œè§„åˆ™ã€‚ä»–ä»¬å–„äºç®¡ç†å’Œæ‰§è¡Œï¼Œå¾€å¾€åœ¨ä¼ä¸šå’Œæ”¿åºœæœºæ„ä¸­æ‹…ä»»é¢†å¯¼èŒåŠ¡ã€‚'
            };
            
            // é¢„è®¾çš„NPCæ•°æ®ï¼ˆäºŒæ¬¡å…ƒé£æ ¼ï¼‰
            const npcData = [
                { name: "æ¡œé›¨(ã•ãã‚‰ã‚)", avatar: "https://picsum.photos/id/237/100/100", personality: "INFP" },
                { name: "æ˜Ÿé‡è¾‰", avatar: "https://picsum.photos/id/238/100/100", personality: "ESTJ" },
                { name: "æœˆè§èŠ±éŸ³", avatar: "https://picsum.photos/id/239/100/100", personality: "ESFP" },
                { name: "é›·ç”µå°†å†›", avatar: "https://picsum.photos/id/240/100/100", personality: "ENTP" },
                { name: "é›ªãƒä¸‹é›ªä¹ƒ", avatar: "https://picsum.photos/id/241/100/100", personality: "INTJ" },
                { name: "å°é³¥éŠç©º", avatar: "https://picsum.photos/id/242/100/100", personality: "ISFJ" },
                { name: "ç¶¾æ³¢é›¶", avatar: "https://picsum.photos/id/243/100/100", personality: "ENFJ" },
                { name: "ä¸äºŒå‘¨åŠ©", avatar: "https://picsum.photos/id/244/100/100", personality: "ISTP" }
            ];
            
            // é¢„è®¾çš„èŠå¤©å†…å®¹ï¼ˆäºŒæ¬¡å…ƒé£æ ¼ï¼‰
            const chatMessages = [
                "ä½ å¥½ï¼åˆæ¬¡è§é¢ï¼Œè¯·å¤šæŒ‡æ•™~ (ã€‚ãƒ»âˆ€ãƒ»)ãƒã‚™",
                "ä»Šå¤©çš„å¤©æ°”çœŸæ˜¯å®Œç¾å‘¢ï¼å°±åƒåŠ¨æ¼«é‡Œçš„æ—¥å¸¸ä¸€æ · â˜€ï¸âœ¨",
                "åˆšä»æ¼«ç”»åº—å‡ºæ¥ï¼Œæ–°çš„è½»å°è¯´çœŸçš„è¶…æ£’ï¼ ğŸ“šâœ¨",
                "ä½ å¹³æ—¶å–œæ¬¢çœ‹ä»€ä¹ˆåŠ¨æ¼«å‘€ï¼Ÿ",
                "æˆ‘æœ€è¿‘åœ¨ç»ƒä¹ ç”»ç”»ï¼Œè™½ç„¶è¿˜ä¸å¦‚å¤§è§¦ä»¬ç”»å¾—å¥½ (Â´âˆ€`)",
                "è¿™å®¶å¥³ä»†å’–å•¡å…çš„å’–å•¡çœŸçš„å¾ˆæ£’ï¼æ¬¢è¿å…‰ä¸´ä¸»äºº~ â˜•ğŸ‘—",
                "å¬è¯´ä¸‹å‘¨æœ‰æ¼«å±•ï¼Œä½ æœ‰å…´è¶£ä¸€èµ·å»å—ï¼Ÿ",
                "ä½ çš„æ€§æ ¼å¾ˆæœ‰è¶£å‘¢ï¼Œå°±åƒæˆ‘å–œæ¬¢çš„åŠ¨æ¼«è§’è‰²ä¸€æ ·~",
                "æˆ‘è¶…å–œæ¬¢æ—…è¡Œï¼ç‰¹åˆ«æ˜¯å»åŠ¨æ¼«åœ£åœ°å·¡ç¤¼ âœˆï¸ğŸ—¾",
                "ä½ è§‰å¾—è¿™ä¸ªåŸå¸‚æœ€åƒå“ªéƒ¨åŠ¨æ¼«çš„åœºæ™¯ï¼Ÿ",
                "æˆ‘æœ€è¿‘çœ‹äº†ä¸€éƒ¨è¶…æ£’çš„æ–°ç•ªï¼Œå¼ºçƒˆæ¨èï¼ ğŸ“ºâœ¨",
                "ä½ çš„ç©¿æ­å¾ˆæœ‰äºŒæ¬¡å…ƒçš„æ„Ÿè§‰å‘¢ï¼(à¹‘Ëƒá´—Ë‚)ï»­",
                "ä»Šå¤©é‡åˆ°äº†å¾ˆæœ‰è¶£çš„äº‹ï¼Œå°±åƒè½»å°è¯´é‡Œçš„å‰§æƒ…~",
                "ä½ å–œæ¬¢ä»€ä¹ˆç±»å‹çš„éŸ³ä¹ï¼Ÿæˆ‘è¶…çˆ±VOCALOIDï¼ ğŸµğŸ¤",
                "æ„Ÿè§‰æˆ‘ä»¬å¾ˆåˆå¾—æ¥å‘¢ï¼å°±åƒå‘½è¿èˆ¬çš„ç›¸é‡~ (Â´âˆ‡ï½€)",
                "ä¸‹æ¬¡ä¸€èµ·å»äºŒæ¬¡å…ƒå‘¨è¾¹åº—é€›é€›å§ï¼ ğŸ›ï¸âœ¨",
                "ä½ çœ‹èµ·æ¥å°±åƒä»åŠ¨æ¼«é‡Œèµ°å‡ºæ¥çš„è§’è‰²å‘¢~",
                "æˆ‘ä¸å¤ªæ“…é•¿ç¤¾äº¤ï¼Œä½†å’Œä½ èŠå¤©å¾ˆå¼€å¿ƒ (ã€ƒï¾Ÿ3ï¾Ÿã€ƒ)",
                "ä½ å¯¹æœªæ¥æœ‰ä»€ä¹ˆæ¢¦æƒ³å—ï¼Ÿæƒ³æˆä¸ºæ¼«ç”»å®¶å—ï¼Ÿ",
                "æˆ‘è¶…çˆ±å°åŠ¨ç‰©ï¼ç‰¹åˆ«æ˜¯çŒ«å’ªï¼Œå¤ªå¯çˆ±äº†~ ğŸ±ğŸ’•",
                "ä»Šå¤©çš„è¿åŠ¿ä¸€å®šå¾ˆå¥½ï¼Œèƒ½é‡åˆ°ä½ çœŸæ˜¯å¤ªæ£’äº†ï¼",
                "ä½ ç©æ‰‹æ¸¸å—ï¼Ÿæœ€è¿‘é‚£ä¸ªäºŒæ¬¡å…ƒæ¸¸æˆè¶…ç«çš„ï¼ğŸ“±âœ¨",
                "è¿™ç§é‚‚é€…æ„Ÿè§‰å°±åƒæ‹çˆ±æ¸¸æˆçš„å‰§æƒ…å‘¢~ (Â´è‰¸ï½€*)",
                "ä½ çš„å£°éŸ³å¾ˆå¥½å¬ï¼Œæœ‰è€ƒè™‘è¿‡å½“å£°ä¼˜å—ï¼ŸğŸ™ï¸",
                "ä¸€èµ·å»å¡æ‹‰OKå”±åŠ¨æ¼«æ­Œæ›²å§ï¼ç»å¯¹å¾ˆæ£’ï¼ğŸ¤ğŸµ"
            ];
            
            // é¢„è®¾çš„åœ°ç‚¹ï¼ˆäºŒæ¬¡å…ƒé£æ ¼ï¼‰
            const locations = [
                "æ¸©é¦¨å°å±‹", "æ¨±èŠ±å…¬å›­", "å›¾ä¹¦é¦†", "å¥³ä»†å’–å•¡å…", "å­¦å›­", "åŒ»é™¢", "ä¾¿åˆ©åº—", 
                "å¥èº«æˆ¿", "ç”µå½±é™¢", "ä¸­å¤®å…¬å›­", "å±…é…’å±‹", "æ‹‰é¢åº—", "ç§‹å¶åŸ", "è½¦ç«™", "æ¼«ç”»åº—"
            ];
            
            // åˆå§‹åŒ–äººç‰©åˆ›å»ºç•Œé¢
            initCharacterCreation();
            
            // åˆå§‹åŒ–åœ°å›¾
            drawMap();
            
            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
            initEventListeners();
            
            // åˆå§‹åŒ–äººç‰©åˆ›å»ºç•Œé¢
            function initCharacterCreation() {
                // å¤´åƒé€‰æ‹©
                const avatarOptions = document.querySelectorAll('.avatar-option');
                avatarOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                        avatarOptions.forEach(opt => opt.classList.remove('border-primary'));
                        avatarOptions.forEach(opt => opt.classList.add('border-transparent'));
                        
                        // æ·»åŠ å½“å‰é€‰ä¸­çŠ¶æ€
                        option.classList.remove('border-transparent');
                        option.classList.add('border-primary');
                        
                        // æ›´æ–°éšè—å­—æ®µ
                        const avatarUrl = option.querySelector('img').src;
                        document.getElementById('avatar-url').value = avatarUrl;
                    });
                });
                
                // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªå¤´åƒ
                avatarOptions[0].classList.remove('border-transparent');
                avatarOptions[0].classList.add('border-primary');
                
                // éšæœºæ€§æ ¼æŒ‰é’®
                document.getElementById('random-personality').addEventListener('click', () => {
                    const personalities = Object.keys(personalityTypes);
                    const randomPersonality = personalities[Math.floor(Math.random() * personalities.length)];
                    document.getElementById('personality').value = randomPersonality;
                    updatePersonalityDescription(randomPersonality);
                });
                
                // æ€§æ ¼é€‰æ‹©å˜åŒ–æ—¶æ›´æ–°æè¿°
                document.getElementById('personality').addEventListener('change', (e) => {
                    updatePersonalityDescription(e.target.value);
                });
                
                // è¡¨å•æäº¤
                document.getElementById('creation-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    createPlayer();
                });
            }
            
            // æ›´æ–°æ€§æ ¼æè¿°
            function updatePersonalityDescription(personality) {
                document.getElementById('personality-description').textContent = personalityDescriptions[personality];
            }
            
            // åˆ›å»ºç©å®¶
            function createPlayer() {
                const nickname = document.getElementById('nickname').value || 'æ–°äººå†’é™©è€…';
                const gender = document.querySelector('input[name="gender"]:checked').value;
                const avatar = document.getElementById('avatar-url').value;
                const personality = document.getElementById('personality').value;
                
                // åˆ›å»ºç©å®¶å¯¹è±¡
                gameState.player = {
                    id: 'player',
                    name: nickname,
                    gender: gender,
                    avatar: avatar,
                    personality: personality,
                    x: gameState.mapSize / 2, // åˆå§‹ä½ç½®åœ¨ä¸­å¿ƒ
                    y: gameState.mapSize / 2,
                    destination: null,
                    acquaintances: []
                };
                
                // åˆ›å»ºNPC
                createNPCs();
                
                // æ›´æ–°UI
                updatePlayerInfo();
                renderNPCsList();
                renderCharacters();
                
                // éšè—åˆ›å»ºç•Œé¢ï¼Œæ˜¾ç¤ºæ¸¸æˆä¸–ç•Œ
                document.getElementById('character-creation').classList.add('hidden');
                document.getElementById('game-world').classList.remove('hidden');
                
                // å¼€å§‹æ¸¸æˆå¾ªç¯
                startGameLoop();
            }
            
            // åˆ›å»ºNPC
            function createNPCs() {
                npcData.forEach((npc, index) => {
                    // éšæœºä½ç½®ï¼Œä½†ç¡®ä¿åœ¨é“è·¯ä¸Š
                    let x, y;
                    do {
                        x = Math.floor(Math.random() * 8) * 100;
                        y = Math.floor(Math.random() * 8) * 100;
                    } while (!isOnRoad(x, y));
                    
                    gameState.npcs.push({
                        id: `npc-${index}`,
                        name: npc.name,
                        avatar: npc.avatar,
                        personality: npc.personality,
                        x: x,
                        y: y,
                        destination: null,
                        acquaintances: []
                    });
                });
            }
            
            // æ›´æ–°ç©å®¶ä¿¡æ¯
            function updatePlayerInfo() {
                document.getElementById('player-avatar').src = gameState.player.avatar;
                document.getElementById('player-avatar-mini').src = gameState.player.avatar;
                document.getElementById('player-name').textContent = gameState.player.name;
                document.getElementById('player-name-mini').textContent = gameState.player.name;
                document.getElementById('player-personality').textContent = 
                    `${personalityTypes[gameState.player.personality]} (${gameState.player.personality})`;
                
                updatePlayerLocation();
            }
            
            // æ›´æ–°ç©å®¶ä½ç½®æ˜¾ç¤º
            function updatePlayerLocation() {
                const locationIndex = Math.floor(gameState.player.x / 100) + Math.floor(gameState.player.y / 100) * 8;
                document.getElementById('player-location').textContent = locations[locationIndex % locations.length];
                document.getElementById('acquaintance-count').textContent = `${gameState.player.acquaintances.length} äºº`;
                document.getElementById('today-activities').textContent = `${gameState.log.length} ä»¶`;
            }
            
            // æ¸²æŸ“NPCåˆ—è¡¨
            function renderNPCsList() {
                const npcsList = document.getElementById('npcs-list');
                npcsList.innerHTML = '';
                
                gameState.npcs.forEach(npc => {
                    const isAcquaintance = gameState.player.acquaintances.includes(npc.id);
                    const npcElement = document.createElement('div');
                    npcElement.className = `flex items-center p-3 border-b last:border-0 hover:bg-slate-50 transition-colors ${isAcquaintance ? 'bg-primary/5' : ''}`;
                    npcElement.innerHTML = `
                        <div class="w-10 h-10 rounded-full overflow-hidden mr-3">
                            <img src="${npc.avatar}" alt="${npc.name}" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-medium text-sm truncate">${npc.name}</h4>
                            <p class="text-xs text-slate-500 truncate">${personalityTypes[npc.personality].split(' - ')[0]}</p>
                        </div>
                        ${isAcquaintance ? `<span class="text-xs px-2 py-0.5 bg-green-100 text-green-800 rounded-full">å·²è®¤è¯†</span>` : ''}
                    `;
                    npcsList.appendChild(npcElement);
                });
            }
            
            // ç»˜åˆ¶åœ°å›¾
            function drawMap() {
                const map = document.getElementById('map');
                map.style.width = `${gameState.mapSize}px`;
                map.style.height = `${gameState.mapSize}px`;
                
                // åˆ›å»ºSVGå…ƒç´ 
                const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                svg.setAttribute("width", gameState.mapSize);
                svg.setAttribute("height", gameState.mapSize);
                map.appendChild(svg);
                
                // ç»˜åˆ¶ç½‘æ ¼é“è·¯
                for (let i = 0; i <= gameState.mapSize; i += gameState.gridSize) {
                    // æ°´å¹³çº¿
                    const hLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    hLine.setAttribute("x1", 0);
                    hLine.setAttribute("y1", i);
                    hLine.setAttribute("x2", gameState.mapSize);
                    hLine.setAttribute("y2", i);
                    hLine.setAttribute("stroke", "#CBD5E1");
                    hLine.setAttribute("stroke-width", "10");
                    svg.appendChild(hLine);
                    
                    // å‚ç›´çº¿
                    const vLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    vLine.setAttribute("x1", i);
                    vLine.setAttribute("y1", 0);
                    vLine.setAttribute("x2", i);
                    vLine.setAttribute("y2", gameState.mapSize);
                    vLine.setAttribute("stroke", "#CBD5E1");
                    vLine.setAttribute("stroke-width", "10");
                    svg.appendChild(vLine);
                }
                
                // ç»˜åˆ¶å»ºç­‘ç‰©
                const buildingColors = ['#93C5FD', '#FCD34D', '#FCA5A5', '#A7F3D0', '#C4B5FD', '#FECACA', '#BFDBFE'];
                const buildingTypes = ['ğŸ«', 'ğŸ¥', 'ğŸª', 'â˜•', 'ğŸ¬', 'ğŸ­', 'ğŸ¢'];
                
                for (let x = 50; x < gameState.mapSize; x += gameState.gridSize) {
                    for (let y = 50; y < gameState.mapSize; y += gameState.gridSize) {
                        // éšæœºå†³å®šæ˜¯å¦æ”¾ç½®å»ºç­‘ç‰©
                        if (Math.random() > 0.3) continue;
                        
                        const building = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                        const size = 80;
                        const color = buildingColors[Math.floor(Math.random() * buildingColors.length)];
                        
                        building.setAttribute("x", x - size/2);
                        building.setAttribute("y", y - size/2);
                        building.setAttribute("width", size);
                        building.setAttribute("height", size);
                        building.setAttribute("rx", 5);
                        building.setAttribute("fill", color);
                        building.setAttribute("opacity", 0.7);
                        svg.appendChild(building);
                        
                        // æ·»åŠ å»ºç­‘ç‰©å›¾æ ‡
                        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                        text.setAttribute("x", x);
                        text.setAttribute("y", y + 8);
                        text.setAttribute("text-anchor", "middle");
                        text.setAttribute("font-size", "24");
                        text.textContent = buildingTypes[Math.floor(Math.random() * buildingTypes.length)];
                        svg.appendChild(text);
                    }
                }
            }
            
            // æ¸²æŸ“æ‰€æœ‰äººç‰©
            function renderCharacters() {
                const mapContainer = document.getElementById('map-container');
                
                // æ¸…é™¤ç°æœ‰è§’è‰²
                document.querySelectorAll('.character').forEach(el => el.remove());
                
                // æ¸²æŸ“ç©å®¶
                renderCharacter(gameState.player, true);
                
                // æ¸²æŸ“NPC
                gameState.npcs.forEach(npc => {
                    renderCharacter(npc, false);
                });
            }
            
            // æ¸²æŸ“å•ä¸ªäººç‰©
            function renderCharacter(character, isPlayer) {
                const mapContainer = document.getElementById('map-container');
                const characterElement = document.createElement('div');
                
                // ç¡®å®šæ ·å¼å’Œç±»
                const classes = `character absolute transform -translate-x-1/2 -translate-y-1/2 transition-all duration-500 ease-out ${isPlayer ? 'z-20' : 'z-10'}`;
                characterElement.className = classes;
                characterElement.id = character.id;
                characterElement.style.left = `${character.x}px`;
                characterElement.style.top = `${character.y}px`;
                
                // å¤´åƒå…ƒç´ 
                const avatarClasses = `w-10 h-10 md:w-12 md:h-12 rounded-full overflow-hidden border-2 ${isPlayer ? 'border-primary avatar-pulse' : 'border-white shadow-md'}`;
                characterElement.innerHTML = `
                    <div class="${avatarClasses}">
                        <img src="${character.avatar}" alt="${character.name}" class="w-full h-full object-cover">
                    </div>
                    <div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 bg-white text-xs font-medium px-2 py-1 rounded shadow whitespace-nowrap">
                        ${character.name}
                    </div>
                `;
                
                mapContainer.appendChild(characterElement);
            }
            
            // æ£€æŸ¥æ˜¯å¦åœ¨é“è·¯ä¸Š
            function isOnRoad(x, y) {
                // æ£€æŸ¥æ˜¯å¦åœ¨æ°´å¹³çº¿æˆ–å‚ç›´çº¿ä¸Š
                return x % gameState.gridSize === 0 || y % gameState.gridSize === 0;
            }
            
            // ç”Ÿæˆéšæœºç›®çš„åœ°
            function generateRandomDestination(character) {
                let x, y;
                do {
                    x = Math.floor(Math.random() * 8) * 100;
                    y = Math.floor(Math.random() * 8) * 100;
                    // ç¡®ä¿ç›®çš„åœ°ä¸å½“å‰ä½ç½®ä¸åŒ
                } while ((x === character.x && y === character.y) || !isOnRoad(x, y));
                
                return { x, y };
            }
            
            // ç§»åŠ¨äººç‰©
            function moveCharacter(character, deltaTime) {
                if (!character.destination) {
                    character.destination = generateRandomDestination(character);
                }
                
                // è®¡ç®—ç§»åŠ¨è·ç¦» (5å…¬é‡Œ/å°æ—¶ï¼Œæ¸¸æˆæ—¶é—´æ˜¯ç°å®çš„timeMultiplierå€)
                // æ¯100px = 2å…¬é‡Œï¼Œæ‰€ä»¥æ¯åƒç´  = 0.02å…¬é‡Œ
                // 5å…¬é‡Œ/å°æ—¶ = 5 / 3600 å…¬é‡Œ/ç§’ (ç°å®æ—¶é—´)
                // æ¸¸æˆä¸­æ¯ç§’ = ç°å®æ—¶é—´çš„timeMultiplierç§’
                // æ‰€ä»¥æ¸¸æˆä¸­æ¯ç§’ç§»åŠ¨: 5 / 3600 * timeMultiplier / 0.02 åƒç´ 
                const moveSpeed = (5 / 3600) * gameState.timeMultiplier / 0.02; // åƒç´ /ç§’
                const distancePerFrame = moveSpeed * deltaTime;
                
                // è®¡ç®—åˆ°ç›®çš„åœ°çš„è·ç¦»
                const dx = character.destination.x - character.x;
                const dy = character.destination.y - character.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance <= distancePerFrame) {
                    // åˆ°è¾¾ç›®çš„åœ°
                    character.x = character.destination.x;
                    character.y = character.destination.y;
                    character.destination = null;
                } else {
                    // å‘ç›®çš„åœ°ç§»åŠ¨
                    const ratio = distancePerFrame / distance;
                    character.x += dx * ratio;
                    character.y += dy * ratio;
                }
                
                // æ›´æ–°UIä½ç½®
                const element = document.getElementById(character.id);
                if (element) {
                    element.style.left = `${character.x}px`;
                    element.style.top = `${character.y}px`;
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦åœ¨æœ€è¿‘èŠå¤©è®°å½•ä¸­
            function hasRecentChat(npcId) {
                const now = Date.now();
                const oneHour = 60 * 60 * 1000; // 1å°æ—¶å†…ä¸é‡å¤èŠå¤©
                
                // æ¸…ç†è¿‡æœŸè®°å½•
                gameState.recentChats = gameState.recentChats.filter(chat => now - chat.timestamp < oneHour);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æœ€è¿‘èŠå¤©
                return gameState.recentChats.some(chat => chat.npcId === npcId);
            }
            
            // æ£€æŸ¥äººç‰©ä¹‹é—´æ˜¯å¦ç›¸é‡
            function checkEncounters() {
                if (gameState.isChatting) return;
                
                // æ£€æŸ¥ç©å®¶ä¸NPCçš„è·ç¦»
                for (const npc of gameState.npcs) {
                    // æ£€æŸ¥æ˜¯å¦æœ€è¿‘å·²ç»èŠè¿‡å¤©
                    if (hasRecentChat(npc.id)) continue;
                    
                    const dx = gameState.player.x - npc.x;
                    const dy = gameState.player.y - npc.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    // å¦‚æœè·ç¦»å°äº20åƒç´ ï¼Œè®¤ä¸ºç›¸é‡
                    if (distance < 20) {
                        startChat(npc);
                        break;
                    }
                }
            }
            
            // å¼€å§‹èŠå¤©
            function startChat(npc) {
                gameState.isChatting = true;
                gameState.currentChatPartner = npc;
                
                // æ·»åŠ åˆ°æœ€è¿‘èŠå¤©è®°å½•
                gameState.recentChats.push({
                    npcId: npc.id,
                    timestamp: Date.now()
                });
                
                // åœæ­¢ç§»åŠ¨
                gameState.player.destination = null;
                npc.destination = null;
                
                // æ˜¾ç¤ºèŠå¤©çª—å£
                const chatWindow = document.getElementById('chat-window');
                document.getElementById('chat-title').textContent = `ä¸ ${npc.name} èŠå¤©ä¸­`;
                
                // éšæœºç”Ÿæˆæ€§æ ¼åŒ¹é…åº¦
                let compatibility = Math.floor(Math.random() * 50) + 30; // 30-80%
                document.getElementById('compatibility').textContent = `æ€§æ ¼åŒ¹é…åº¦: ${compatibility}%`;
                
                // æ¸…ç©ºèŠå¤©æ¶ˆæ¯
                const chatMessagesContainer = document.getElementById('chat-messages');
                chatMessagesContainer.innerHTML = '';
                
                // æ·»åŠ åˆå§‹æ¶ˆæ¯
                addChatMessage(npc.name, getRandomChatMessage(), false);
                
                chatWindow.classList.remove('hidden');
                
                // è‡ªåŠ¨å‘é€æ¶ˆæ¯
                let messageCount = 0;
                const totalMessages = 5 + Math.floor(Math.random() * 4); // 5-8æ¡æ¶ˆæ¯
                const messageInterval = setInterval(() => {
                    if (!gameState.isChatting || messageCount >= totalMessages) {
                        clearInterval(messageInterval);
                        // èŠå¤©ç»“æŸ
                        setTimeout(endChat, 2000);
                        return;
                    }
                    
                    // éšæœºå†³å®šè°å‘é€æ¶ˆæ¯
                    if (Math.random() > 0.5) {
                        addChatMessage(npc.name, getRandomChatMessage(), false);
                    } else {
                        addChatMessage(gameState.player.name, getRandomChatMessage(), true);
                    }
                    
                    // éšæœºè°ƒæ•´åŒ¹é…åº¦
                    const change = Math.floor(Math.random() * 7) - 3; // -3åˆ°3ä¹‹é—´çš„éšæœºå˜åŒ–
                    compatibility = Math.max(10, Math.min(90, compatibility + change));
                    document.getElementById('compatibility').textContent = `æ€§æ ¼åŒ¹é…åº¦: ${compatibility}%`;
                    
                    messageCount++;
                }, 2000); // æ¯2ç§’å‘é€ä¸€æ¡æ¶ˆæ¯
            }
            
            // è·å–éšæœºèŠå¤©æ¶ˆæ¯
            function getRandomChatMessage() {
                return chatMessages[Math.floor(Math.random() * chatMessages.length)];
            }
            
            // æ·»åŠ èŠå¤©æ¶ˆæ¯
            function addChatMessage(sender, message, isPlayer) {
                const chatMessagesContainer = document.getElementById('chat-messages');
                const messageElement = document.createElement('div');
                
                messageElement.className = `flex ${isPlayer ? 'justify-end' : 'justify-start'}`;
                
                const bubbleClass = isPlayer 
                    ? 'bg-primary/10 text-slate-800 rounded-lg rounded-tr-none p-2 max-w-[80%] relative chat-bubble-right'
                    : 'bg-white border border-slate-200 text-slate-800 rounded-lg rounded-tl-none p-2 max-w-[80%] relative chat-bubble-left shadow-sm';
                
                messageElement.innerHTML = `
                    <div class="${bubbleClass}">
                        <div class="text-xs font-medium mb-1 ${isPlayer ? 'text-primary' : 'text-slate-500'}">${sender}</div>
                        <div class="text-sm">${message}</div>
                    </div>
                `;
                
                chatMessagesContainer.appendChild(messageElement);
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            }
            
            // ç»“æŸèŠå¤©
            function endChat() {
                if (!gameState.isChatting || !gameState.currentChatPartner) return;
                
                const npc = gameState.currentChatPartner;
                
                // éšè—èŠå¤©çª—å£
                document.getElementById('chat-window').classList.add('hidden');
                
                // æ ‡è®°ä¸ºå·²è®¤è¯†
                if (!gameState.player.acquaintances.includes(npc.id)) {
                    gameState.player.acquaintances.push(npc.id);
                    npc.acquaintances.push(gameState.player.id);
                    
                    // æ›´æ–°UI
                    renderNPCsList();
                    updatePlayerInfo();
                }
                
                // æ·»åŠ æ—¥å¿—
                addLogEntry(npc);
                
                // é‡ç½®çŠ¶æ€
                gameState.isChatting = false;
                gameState.currentChatPartner = null;
                
                // è®©è§’è‰²ç»§ç»­ç§»åŠ¨
                gameState.player.destination = generateRandomDestination(gameState.player);
                npc.destination = generateRandomDestination(npc);
            }
            
            // æ·»åŠ æ—¥å¿—æ¡ç›®
            function addLogEntry(npc) {
                const compatibility = parseInt(document.getElementById('compatibility').textContent.match(/\d+/)[0]);
                const logEntry = {
                    id: Date.now(),
                    type: 'encounter',
                    time: new Date(gameState.virtualTime),
                    title: `ä¸ ${npc.name} çš„å‘½è¿é‚‚é€…`,
                    content: `ä½ ä¸ ${npc.name} è¿›è¡Œäº†ä¸€æ¬¡æ„‰å¿«çš„äº¤è°ˆã€‚ä½ ä»¬çš„æ€§æ ¼åŒ¹é…åº¦ä¸º ${compatibility}%ã€‚è¿™ç§ç›¸é‡å°±åƒåŠ¨æ¼«é‡Œçš„å‰§æƒ…ä¸€æ ·ç¾å¥½~`,
                    image: generateRandomImage(compatibility),
                    npcId: npc.id,
                    npcName: npc.name
                };
                
                gameState.log.unshift(logEntry);
                updateLogPanel();
                
                // æ˜¾ç¤ºé€šçŸ¥
                document.getElementById('log-notification').classList.remove('hidden');
                
                // æ›´æ–°æ´»åŠ¨è®¡æ•°
                updatePlayerInfo();
            }
            
            // ç”Ÿæˆéšæœºå›¾ç‰‡
            function generateRandomImage(compatibility) {
                // æ ¹æ®åŒ¹é…åº¦ç”Ÿæˆä¸åŒç±»å‹çš„å›¾ç‰‡
                if (compatibility > 70) {
                    return `https://picsum.photos/id/${30 + Math.floor(Math.random() * 5)}/300/200`; // ç§¯æçš„å›¾ç‰‡
                } else if (compatibility > 40) {
                    return `https://picsum.photos/id/${40 + Math.floor(Math.random() * 5)}/300/200`; // ä¸­æ€§çš„å›¾ç‰‡
                } else {
                    return `https://picsum.photos/id/${50 + Math.floor(Math.random() * 5)}/300/200`; // ä¸å¤ªç§¯æçš„å›¾ç‰‡
                }
            }
            
            // æ›´æ–°æ—¥å¿—é¢æ¿
            function updateLogPanel() {
                const logContent = document.getElementById('log-content');
                
                if (gameState.log.length === 0) {
                    logContent.innerHTML = `
                        <div class="text-center text-slate-500 py-8">
                            <i class="fa fa-book-open text-4xl mb-2 opacity-30"></i>
                            <p>ä½ çš„äººç”Ÿæ—¥å¿—è¿˜æ˜¯ç©ºç™½çš„</p>
                            <p class="text-sm mt-1">ä¸å…¶ä»–è§’è‰²äº’åŠ¨æ¥è®°å½•ç²¾å½©çš„äºŒæ¬¡å…ƒç¬é—´~</p>
                        </div>
                    `;
                    return;
                }
                
                logContent.innerHTML = '';
                
                gameState.log.forEach(entry => {
                    const dateStr = entry.time.toLocaleDateString();
                    const timeStr = entry.time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    const logEntryElement = document.createElement('div');
                    logEntryElement.className = 'bg-slate-50 rounded-lg p-4 shadow-sm';
                    logEntryElement.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-medium">${entry.title}</h3>
                            <span class="text-xs text-slate-500">${dateStr} ${timeStr}</span>
                        </div>
                        <p class="text-sm text-slate-700 mb-3">${entry.content}</p>
                        <div class="mb-3 rounded overflow-hidden">
                            <img src="${entry.image}" alt="${entry.title}" class="w-full h-48 object-cover">
                        </div>
                        ${entry.npcId ? `<button class="send-message-btn text-sm text-primary hover:text-primary/80 transition-colors" data-npc-id="${entry.npcId}" data-npc-name="${entry.npcName}">
                            <i class="fa fa-paper-plane mr-1"></i> ç»™ ${entry.npcName} å‘æ¶ˆæ¯
                        </button>` : ''}
                    `;
                    
                    logContent.appendChild(logEntryElement);
                });
                
                // æ·»åŠ å‘æ¶ˆæ¯æŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.send-message-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const npcId = e.target.dataset.npcId || e.target.parentElement.dataset.npcId;
                        const npcName = e.target.dataset.npcName || e.target.parentElement.dataset.npcName;
                        openMessageWindow(npcId, npcName);
                    });
                });
            }
            
            // æ‰“å¼€æ¶ˆæ¯çª—å£
            function openMessageWindow(npcId, npcName) {
                document.getElementById('message-recipient').textContent = npcName;
                document.getElementById('message-content').value = '';
                document.getElementById('message-window').classList.remove('hidden');
                
                // å­˜å‚¨æ¥æ”¶è€…ID
                document.getElementById('send-message').dataset.npcId = npcId;
                document.getElementById('send-message').dataset.npcName = npcName;
            }
            
            // å‘é€æ¶ˆæ¯
            function sendMessage(npcId, npcName) {
                const messageContent = document.getElementById('message-content').value.trim();
                if (!messageContent) return;
                
                // æ·»åŠ åˆ°æ—¥å¿—
                const logEntry = {
                    id: Date.now(),
                    type: 'message',
                    time: new Date(gameState.virtualTime),
                    title: `ç»™ ${npcName} å‘é€äº†ç§ä¿¡`,
                    content: `"${messageContent}" - å°±åƒè½»å°è¯´é‡Œçš„æƒ…èŠ‚ä¸€æ ·ï¼Œé€šè¿‡æ–‡å­—ä¼ è¾¾å¿ƒæ„~`,
                    image: `https://picsum.photos/id/${60 + Math.floor(Math.random() * 5)}/300/200`,
                    npcId: npcId,
                    npcName: npcName
                };
                
                gameState.log.unshift(logEntry);
                updateLogPanel();
                updatePlayerInfo();
                
                // å…³é—­æ¶ˆæ¯çª—å£
                document.getElementById('message-window').classList.add('hidden');
                
                // æ˜¾ç¤ºé€šçŸ¥
                document.getElementById('log-notification').classList.remove('hidden');
            }
            
            // æ›´æ–°è™šæ‹Ÿæ—¶é—´
            function updateVirtualTime(deltaTime) {
                // è®¡ç®—åº”è¯¥å¢åŠ çš„æ¯«ç§’æ•° (ç°å®æ—¶é—´ * æ—¶é—´å€æ•°)
                const millisecondsToAdd = deltaTime * 1000 * gameState.timeMultiplier;
                gameState.virtualTime.setTime(gameState.virtualTime.getTime() + millisecondsToAdd);
                
                // æ›´æ–°UI
                const timeStr = gameState.virtualTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                document.getElementById('virtual-time').textContent = timeStr;
            }
            
            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
            function initEventListeners() {
                // åœ°å›¾ç‚¹å‡» - è®¾ç½®ç›®çš„åœ°
                document.getElementById('map-container').addEventListener('click', (e) => {
                    if (gameState.moveMode !== 'direct' || !gameState.player || gameState.isChatting) return;
                    
                    // è·å–ç‚¹å‡»ä½ç½®ç›¸å¯¹äºåœ°å›¾çš„åæ ‡
                    const rect = document.getElementById('map').getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // æ‰¾åˆ°æœ€è¿‘çš„é“è·¯ç‚¹
                    const gridSize = gameState.gridSize;
                    let closestX, closestY;
                    
                    // æ£€æŸ¥æ˜¯å¦æ›´é è¿‘æ°´å¹³çº¿æˆ–å‚ç›´çº¿
                    if (x % gridSize < gridSize / 2) {
                        closestX = Math.floor(x / gridSize) * gridSize;
                    } else {
                        closestX = Math.ceil(x / gridSize) * gridSize;
                    }
                    
                    if (y % gridSize < gridSize / 2) {
                        closestY = Math.floor(y / gridSize) * gridSize;
                    } else {
                        closestY = Math.ceil(y / gridSize) * gridSize;
                    }
                    
                    // ç¡®ä¿åœ¨åœ°å›¾èŒƒå›´å†…
                    closestX = Math.max(0, Math.min(closestX, gameState.mapSize));
                    closestY = Math.max(0, Math.min(closestY, gameState.mapSize));
                    
                    // è®¾ç½®ç›®çš„åœ°
                    gameState.player.destination = { x: closestX, y: closestY };
                });
                
                // ç§»åŠ¨æ¨¡å¼åˆ‡æ¢
                document.getElementById('move-mode-toggle').addEventListener('click', () => {
                    gameState.moveMode = gameState.moveMode === 'random' ? 'direct' : 'random';
                    const btn = document.getElementById('move-mode-toggle');
                    
                    if (gameState.moveMode === 'random') {
                        btn.innerHTML = '<i class="fa fa-random mr-1"></i>éšæœºç§»åŠ¨';
                    } else {
                        btn.innerHTML = '<i class="fa fa-map-marker mr-1"></i>æŒ‡å®šç§»åŠ¨';
                    }
                });
                
                // æ—¶é—´æ§åˆ¶
                document.getElementById('time-control').addEventListener('input', (e) => {
                    gameState.timeMultiplier = parseInt(e.target.value);
                    document.getElementById('time-multiplier').textContent = `${gameState.timeMultiplier}x`;
                    document.getElementById('time-control-btn').querySelector('span').textContent = `æ—¶é—´: ${gameState.timeMultiplier}x`;
                });
                
                // æ—¶é—´æ§åˆ¶æŒ‰é’®
                document.getElementById('time-control-btn').addEventListener('click', () => {
                    // åˆ‡æ¢å¸¸ç”¨æ—¶é—´å€æ•°
                    const multipliers = [1, 60, 120, 180, 240, 300];
                    const currentIndex = multipliers.indexOf(gameState.timeMultiplier);
                    const nextIndex = (currentIndex + 1) % multipliers.length;
                    
                    gameState.timeMultiplier = multipliers[nextIndex];
                    document.getElementById('time-control').value = gameState.timeMultiplier;
                    document.getElementById('time-multiplier').textContent = `${gameState.timeMultiplier}x`;
                    document.getElementById('time-control-btn').querySelector('span').textContent = `æ—¶é—´: ${gameState.timeMultiplier}x`;
                });
                
                // æ—¥å¿—æŒ‰é’®
                document.getElementById('log-btn').addEventListener('click', () => {
                    document.getElementById('log-panel').classList.remove('hidden');
                    document.getElementById('log-notification').classList.add('hidden');
                });
                
                // å…³é—­æ—¥å¿—
                document.getElementById('close-log').addEventListener('click', () => {
                    document.getElementById('log-panel').classList.add('hidden');
                });
                
                // æ¸…ç©ºæ—¥å¿—
                document.getElementById('clear-log').addEventListener('click', () => {
                    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                        gameState.log = [];
                        updateLogPanel();
                        updatePlayerInfo();
                    }
                });
                
                // æ¶ˆæ¯çª—å£
                document.getElementById('close-message').addEventListener('click', () => {
                    document.getElementById('message-window').classList.add('hidden');
                });
                
                document.getElementById('cancel-message').addEventListener('click', () => {
                    document.getElementById('message-window').classList.add('hidden');
                });
                
                document.getElementById('send-message').addEventListener('click', (e) => {
                    const npcId = e.target.dataset.npcId;
                    const npcName = e.target.dataset.npcName;
                    sendMessage(npcId, npcName);
                });
                
                // çª—å£æ»šåŠ¨æ—¶æ”¹å˜å¯¼èˆªæ æ ·å¼
                window.addEventListener('scroll', () => {
                    const header = document.querySelector('header');
                    if (window.scrollY > 10) {
                        header.classList.add('shadow');
                    } else {
                        header.classList.remove('shadow');
                    }
                });
            }
            
            // æ¸¸æˆä¸»å¾ªç¯
            function startGameLoop() {
                let lastTime = performance.now();
                
                function gameLoop(currentTime) {
                    // è®¡ç®—æ—¶é—´å·® (ç§’)
                    const deltaTime = (currentTime - lastTime) / 1000;
                    lastTime = currentTime;
                    
                    // æ›´æ–°è™šæ‹Ÿæ—¶é—´
                    updateVirtualTime(deltaTime);
                    
                    // å¦‚æœæ­£åœ¨èŠå¤©ï¼Œä¸ç§»åŠ¨
                    if (!gameState.isChatting) {
                        // ç§»åŠ¨ç©å®¶ (å¦‚æœæ˜¯éšæœºæ¨¡å¼)
                        if (gameState.moveMode === 'random' || gameState.player.destination) {
                            moveCharacter(gameState.player, deltaTime);
                        }
                        
                        // ç§»åŠ¨NPC
                        gameState.npcs.forEach(npc => {
                            moveCharacter(npc, deltaTime);
                        });
                        
                        // æ£€æŸ¥ç›¸é‡
                        checkEncounters();
                    }
                    
                    // æ›´æ–°ç©å®¶ä½ç½®ä¿¡æ¯
                    updatePlayerLocation();
                    
                    requestAnimationFrame(gameLoop);
                }
                
                requestAnimationFrame(gameLoop);
            }
        });
    </script>
</body>
</html>
